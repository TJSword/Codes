// pages/VoteStart/VoteStart.js
const app = getApp()
import { request, saveRequest } from '../../utils/util.js';
Page({

  /**
   * 页面的初始数据
   */
  data: {
    statusBarHeight: app.globalData.statusBarHeight,
    chooseAniBox:[false,false,false,false,false,false,false,false,false,false,false],
    choosePatternArr:['单选','多选'],
    chooseCrowdArr:['全体成员','仅经营者'],
    chooseCrowValueArr:['qtcy','jjyz'],
    optionsBit:2,
    optionsArr:[null,null]
  },
  goBack: function (e) {//点击返回按钮 返回上一层页面
    wx.redirectTo({
      url: '../Index/Index',
    })
  },
  choose_box(e) {
    let aniId = e.currentTarget.dataset.id
    let arr = this.data.chooseAniBox;
    arr[aniId] = true;
    this.setData({
      chooseAniBox: arr
    })
  },
  vote_title(e) {
    console.log(e.detail.value)
    this.setData({
      voteTitle: e.detail.value
    })
  },
  vote_title_blur(e) {
    if (e.detail.value === "") {
      let arr = this.data.chooseAniBox;
      arr[0] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },

  vote_content(e){
    this.setData({
      voteContent: e.detail.value
    })
  },
  vote_content_blur(e) {
    if (e.detail.value === "") {
      let arr = this.data.chooseAniBox;
      arr[1] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  choosePattern(e){
    this.setData({
      choosePatternIndex: e.detail.value
    })
  },
  choosePatternCancel(e){
    if (!this.data.choosePatternIndex) {
      let aniId = e.currentTarget.dataset.id
      let arr = this.data.chooseAniBox;
      arr[aniId] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  endDate(e) {
    this.setData({
      endDate: e.detail.value
    })
  },
  endDateCancel(e) {
    if (!this.data.endDate) {
      let aniId = e.currentTarget.dataset.id
      let arr = this.data.chooseAniBox;
      arr[aniId] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  chooseCrowd(e) {
    this.setData({
      chooseCrowdIndex: e.detail.value
    })
  },
  chooseCrowdCancel(e) {
    if (!this.data.chooseCrowdIndex) {
      let aniId = e.currentTarget.dataset.id
      let arr = this.data.chooseAniBox;
      arr[aniId] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  minus(e){
    let bit = this.data.optionsBit - 1;
    let arr = this.data.optionsArr;
    arr.pop()
    this.setData({
      optionsBit: bit,
      optionsArr:arr
    })
  },
  addOption(){
    let bit = this.data.optionsBit + 1;
    let arr = this.data.optionsArr;
    arr.push(null)
    this.setData({
      optionsBit: bit,
      optionsArr: arr
    })
  },
  vote_options(e){
    console.log(e.currentTarget.dataset.index)
    console.log(e.detail.value)
    let index = e.currentTarget.dataset.index;
    let value = e.detail.value;
    let arr = this.data.optionsArr;
    arr[index] = value;
    this.setData({
      optionsArr:arr
    })
    console.log(this.data.optionsArr)
  },
  vote_options_blur(e){
    if (e.detail.value === "") {
      let arr = this.data.chooseAniBox;
      arr[e.currentTarget.dataset.index + 5] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  checkOptions(arr){
    for(let i = 0; i < arr.length;i++){
      if(arr[i] === null || arr[i] ===''){
        return true
      }
    }
    return false
  },
  submit(){
    if (this.data.voteTitle === '' || this.data.voteTitle === undefined){
      wx.showToast({
        title: '请填写标题',
        icon:'none'
      })
    }else if(this.data.voteContent === '' || this.data.voteContent === undefined){
      wx.showToast({
        title: '请填写补充内容',
        icon:'none'
      })
    } else if (this.data.choosePatternIndex === undefined){
      wx.showToast({
        title: '请选择模式',
        icon:'none'
      })
    }else if(this.data.endDate === undefined){
      wx.showToast({
        title: '请选择截止时间',
        icon:'none'
      })
    } else if (this.data.chooseCrowdIndex === undefined){
      wx.showToast({
        title: '请选择参与人群',
        icon:'none'
      })
    } else if (this.checkOptions(this.data.optionsArr)){
      wx.showToast({
        title: '请先写选项\n多余的选项请删除',
        icon:'none'
      })
    }else{
      console.log('通过验证')
      wx.showModal({
        content: '确认发起投票?',
        success:res=>{
          if (res.confirm) {
            this.setData({
              loading: true
            })
              saveRequest('/vote/save', 'post', {
                title: this.data.voteTitle,
                content: this.data.voteContent,
                joiner: (this.data.chooseCrowdIndex * 1 + 1) + '',
                chooseType: (this.data.choosePatternIndex * 1 + 1) + '',
                abortDate: this.data.endDate,
                options: this.data.optionsArr
              }, 'application/json').then(res => {
                console.log(res)
                this.setData({
                  loading: false
                })
                if (res.code === 0) {
                  wx.showToast({
                    title: '发起投票成功',
                    icon: 'none'
                  })
                  setTimeout(() => {
                    wx.navigateTo({
                      url: '../Vote/Vote',
                    })
                  }, 1000)
                } else {
                  wx.showToast({
                    title: '发起失败，请联系管理员',
                    icon: "none"
                  })
                }
              })
          }
        }
      })

    }
  },
  checkVote(){
    request('/vote/check/voting','get',{}).then(res=>{
      console.log(res)
      if(res.code == 0){
        this.setData({
          hasVoting:false
        })
      }else if(res.code == 200){
        this.setData({
          hasVoting: true
        })
      }else if(res.code == 500){
        wx.showToast({
          title: '未知异常,请联系管理员',
          icon:'none'
        })
      }
    })
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.checkVote()

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
})