// pages/IssuedShare/IssuedShare.js
const app = getApp();
import { request, saveRequest} from '../../utils/util.js';
Page({

  /**
   * 页面的初始数据
   */
  data: {
    statusBarHeight: app.globalData.statusBarHeight,
    chooseAniBox: [false, false, false, false,false],
  },

  goBack: function (e) {//点击返回按钮 返回上一层页面
    wx.redirectTo({
      url: '../Index/Index',
    })
  },
  choose_box(e) {
    let aniId = e.currentTarget.dataset.id
    let arr = this.data.chooseAniBox;
    // if (aniId == 4){ // 解决 ios上无法聚焦的问题
    //   arr[4]=false
    //   this.setData({
    //     chooseAniBox: arr
    //   })
    // }
    arr[aniId] = true;
    this.setData({
      chooseAniBox: arr
    })
  },

  task_name(e){
    this.setData({
      taskName: e.detail.value
    })
  },
  task_name_blur(e) {
    if (e.detail.value === "") {
      let arr = this.data.chooseAniBox;
      arr[0] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  task_date(e){
    this.setData({
      taskDate: e.detail.value
    })
  },
  task_date_cancel(e){
    if (!this.data.taskDate) {
      let aniId = e.currentTarget.dataset.id
      let arr = this.data.chooseAniBox;
      arr[aniId] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  startTime(e){
    this.setData({
      startTime:e.detail.value
    })
  },
  startTimeCancel(e){
    if (!this.data.startTime) {
      let aniId = e.currentTarget.dataset.id
      let arr = this.data.chooseAniBox;
      arr[aniId] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  endTime(e){
    this.setData({
      endTime:e.detail.value
    })
  },
  endTimeCancel(e){
    if (!this.data.startTime) {
      let aniId = e.currentTarget.dataset.id
      let arr = this.data.chooseAniBox;
      arr[aniId] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  task_content(e){
    this.setData({
      taskContent: e.detail.value
    })
  },
  task_content_blur(e){
    if (e.detail.value === "") {
      let arr = this.data.chooseAniBox;
      arr[4] = false;
      this.setData({
        chooseAniBox: arr
      })
    }
  },
  submit(){
    if (this.data.taskName === "" || this.data.taskName === undefined){
      wx.showToast({
        title: '请填写课题名称',
        icon:'none'
      })
    } else if (this.data.taskDate === undefined){
      wx.showToast({
        title: '请选择分享日期',
        icon:'none'
      })
    }else if(this.data.startTime === undefined){
      wx.showToast({
        title: '请选择开始时间',
        icon:'none'
      })
    }else if(this.data.endTime === undefined){
      wx.showToast({
        title: '请选择结束时间',
        icon:'none'
      })
    } else if (this.data.taskContent === "" || this.data.taskContent === undefined){
      wx.showToast({
        title: '请填写课题简介',
        icon:'none'
      })
    }else{
      if(!this.data.isFinished){
        wx.showModal({
          content: '确认发布课题?',
          success:res=>{
            if(res.confirm){
              this.setData({
                loading:true
              })
              saveRequest('/share/save','post',{
                title: this.data.taskName,
                content: this.data.taskContent,
                startDate: this.data.taskDate + ' ' + this.data.startTime,
                endDate: this.data.taskDate + ' ' + this.data.endTime,
              },'application/json').then(res=>{
                this.setData({
                  loading:false,
                  isFinished:true,
                  id:res.id
                })
                console.log(res)
                if(res.code == 0){
                  wx.showToast({
                    title: '发布课题成功 \n请转发至工作群',
                    icon:'none'
                  })
                }
              })
            }
          }
        })
      }
    }
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
    wx.redirectTo({
      url: '../Index/Index',
    })
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
    return {
      title:this.data.taskName,
      path: '/pages/ShareDetail/ShareDetail?id=' + this.data.id
    }
  }
})